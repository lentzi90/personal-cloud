apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: kind-deploy
spec:
  steps:
  - try:
    # Apply cert-manager manifests
    - script:
        timeout: 1m
        content: kubectl apply -k cert-manager/overlays/kind
    - assert:
        timeout: 2m
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: cert-manager-webhook
            namespace: cert-manager
          status:
            (conditions[?type == 'Available']):
            - status: 'True'
  - try:
    # Apply argocd manifests
    - script:
        timeout: 1m
        content: kubectl apply -k argocd/overlays/kind
    # Verify that the argocd-server deployment is ready
    - assert:
        timeout: 2m
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: argocd-server
            namespace: argocd
          status:
            # filter conditions array to keep elements where `type == 'Ready'`
            # and assert there's a single element matching the filter
            # and that this element status is `True`
            (conditions[?type == 'Available']):
            - status: 'True'
  - try:
    # Apply the app of apps
    - script:
        timeout: 10s
        content: kubectl apply -k apps/kind
    # Ensure that the external-secrets are operational before continuing
    - assert:
        timeout: 2m
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: external-secrets-webhook
            namespace: external-secrets
          status:
            (conditions[?type == 'Available']):
            - status: 'True'
    # Create secret store and token secret
    - script:
        timeout: 10s
        content: |
          kubectl -n external-secrets create secret generic bitwarden-access-token --from-literal=token=${BITWARDEN_ACCESS_TOKEN}
          kubectl apply -f secret-store/test-secretstore.yaml
    # Verify that nextcloud becomes ready
    - assert:
        timeout: 5m
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: nextcloud
            namespace: nextcloud
          status:
            (conditions[?type == 'Available']):
            - status: 'True'
    # Verify app of apps
    - assert:
        timeout: 5m
        resource:
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: apps
            namespace: argocd
          status:
            health:
              status: Healthy
            sync:
              status: Synced
